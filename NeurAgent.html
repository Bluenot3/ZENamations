  <html><head><base href="https://websim.ai/">
<title>AI Agent Framework CLI with Project Management</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

body {
  font-family: 'Share Tech Mono', monospace;
  background-color: #0a0b1e;
  color: #00ffff;
  padding: 20px;
  margin: 0;
  display: flex;
  height: 100vh;
}

#left-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
}

#middle-panel {
  width: 300px;
  margin-left: 20px;
  display: flex;
  flex-direction: column;
}

#right-panel {
  width: 300px;
  margin-left: 20px;
  display: flex;
  flex-direction: column;
  position: relative;
}

#chat-log {
  flex-grow: 1;
  overflow-y: auto;
  border: 1px solid #00ffff;
  padding: 10px;
  margin-bottom: 10px;
  background-color: rgba(0, 255, 255, 0.05);
  box-shadow: 0 0 10px #00ffff;
}

#error-log {
  color: #ff00ff;
  margin-top: 10px;
  text-shadow: 0 0 5px #ff00ff;
}

#user-input {
  width: 100%;
  background-color: #0a0b1e;
  color: #00ffff;
  border: 1px solid #00ffff;
  padding: 10px;
  font-family: 'Share Tech Mono', monospace;
  font-size: 16px;
  box-shadow: 0 0 10px #00ffff;
}

#context-info {
  margin-top: 20px;
  border: 1px solid #00ffff;
  padding: 10px;
  background-color: rgba(0, 255, 255, 0.05);
  box-shadow: 0 0 10px #00ffff;
}

#file-explorer {
  border: 1px solid #00ffff;
  padding: 10px;
  background-color: rgba(0, 255, 255, 0.05);
  box-shadow: 0 0 10px #00ffff;
  margin-bottom: 10px;
  height: 150px;
  overflow-y: auto;
}

#file-display {
  flex-grow: 1;
  border: 1px solid #00ffff;
  padding: 10px;
  background-color: rgba(0, 255, 255, 0.05);
  box-shadow: 0 0 10px #00ffff;
  overflow-y: auto;
  white-space: pre-wrap;
}

#preview {
  flex-grow: 1;
  border: 1px solid #00ffff;
  background-color: white;
  box-shadow: 0 0 10px #00ffff;
  overflow: hidden;
  position: relative;
}

#preview iframe {
  width: 100%;
  height: 100%;
  border: none;
}

#title {
  text-align: center;
  font-size: 24px;
  margin-bottom: 20px;
  text-shadow: 0 0 10px #00ffff;
}

.message {
  margin-bottom: 10px;
  padding: 5px;
  border-radius: 5px;
  animation: fadeIn 0.5s;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.system { color: #ff00ff; }
.user { color: #00ff00; }
.agent { color: #ffff00; }

.file-item {
  cursor: pointer;
  padding: 2px 5px;
}

.file-item:hover {
  background-color: rgba(0, 255, 255, 0.2);
}

::-webkit-scrollbar {
  width: 10px;
}

::-webkit-scrollbar-track {
  background: #0a0b1e;
}

::-webkit-scrollbar-thumb {
  background: #00ffff;
  border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
  background: #00cccc;
}

.fullscreen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 9999;
}

#file-export-menu, #left-menu {
  position: fixed;
  top: 10px;
  width: 50px;
  height: 50px;
  background-color: rgba(44, 44, 44, 0.7);
  border-radius: 5px;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  transition: all 0.3s ease;
  z-index: 1000;
}

#left-menu {
  right: 70px;
}

#file-export-menu {
  right: 10px;
}

#file-export-menu:hover, #left-menu:hover {
  background-color: rgba(60, 60, 60, 0.7);
}

#file-export-icon, #left-menu-icon {
  width: 30px;
  height: 30px;
  fill: #ffffff;
}

#file-export-overlay, #left-menu-overlay {
  position: fixed;
  top: 70px;
  width: 300px;
  background-color: rgba(44, 44, 44, 0.9);
  border-radius: 5px;
  padding: 20px;
  display: none;
  flex-direction: column;
  align-items: center;
  z-index: 1000;
  max-height: 80vh;
  overflow-y: auto;
}

#file-export-overlay {
  right: 10px;
}

#left-menu-overlay {
  right: 70px;
}

#file-export-overlay.active, #left-menu-overlay.active {
  display: flex;
}

#create-zip-button, #save-project-button, .load-project-button, .delete-project-button, .menu-button {
  background-color: rgba(76, 175, 80, 0.7);
  border: none;
  color: white;
  padding: 10px 20px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  margin: 10px 0;
  cursor: pointer;
  border-radius: 5px;
  transition: background-color 0.3s;
  width: 100%;
}

#create-zip-button:hover, #save-project-button:hover, .load-project-button:hover, .delete-project-button:hover, .menu-button:hover {
  background-color: rgba(69, 160, 73, 0.7);
}

.delete-project-button {
  background-color: rgba(244, 67, 54, 0.7);
}

.delete-project-button:hover {
  background-color: rgba(211, 47, 47, 0.7);
}

#file-drop-area {
  border: 2px dashed #00ffff;
  border-radius: 5px;
  padding: 20px;
  text-align: center;
  margin-bottom: 10px;
  cursor: pointer;
}

#file-drop-area.dragover {
  background-color: rgba(0, 255, 255, 0.1);
}

#project-list {
  width: 100%;
  max-height: 200px;
  overflow-y: auto;
  margin-top: 10px;
}

.project-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 5px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.project-item:last-child {
  border-bottom: none;
}

.menu-section {
  margin-bottom: 20px;
  width: 100%;
}

.menu-section h3 {
  color: #00ffff;
  border-bottom: 1px solid #00ffff;
  padding-bottom: 5px;
  margin-bottom: 10px;
}

#instructions-textarea {
  width: 100%;
  height: 100px;
  background-color: rgba(0, 255, 255, 0.1);
  color: #ffffff;
  border: 1px solid #00ffff;
  border-radius: 5px;
  padding: 10px;
  font-family: 'Share Tech Mono', monospace;
  resize: vertical;
  margin-bottom: 10px;
}

#fullscreen-button {
  position: absolute;
  top: 10px;
  right: 10px;
  background-color: rgba(0, 255, 255, 0.3);
  border: none;
  color: #ffffff;
  width: 30px;
  height: 30px;
  border-radius: 5px;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  transition: background-color 0.3s;
  z-index: 1001;
}

#fullscreen-button:hover {
  background-color: rgba(0, 255, 255, 0.5);
}

#fullscreen-icon {
  width: 20px;
  height: 20px;
  fill: #ffffff;
}

</style>
</head>
<body>
<div id="left-panel">
  <div id="title">AI Agent Framework CLI</div>
  <div id="chat-log"></div>
  <div id="error-log"></div>
  <input type="text" id="user-input" placeholder="Enter command or message...">
  <div id="context-info"></div>
</div>
<div id="middle-panel">
  <h3>File Explorer</h3>
  <div id="file-explorer"></div>
  <h3>File Content</h3>
  <div id="file-display"></div>
</div>
<div id="right-panel">
  <h3>Preview</h3>
  <div id="preview">
    <iframe id="preview-frame"></iframe>
    <button id="fullscreen-button">
      <svg id="fullscreen-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M0 0h24v24H0z" fill="none"/>
        <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
      </svg>
    </button>
  </div>
</div>

<div id="left-menu">
  <svg id="left-menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
  </svg>
</div>

<div id="left-menu-overlay">
  <div class="menu-section">
    <h3>Project Manager</h3>
    <button id="save-project-button" class="menu-button">Save Project</button>
    <div id="project-list"></div>
  </div>
  
  <div class="menu-section">
    <h3>Simulation Control</h3>
    <button id="start-simulation-button" class="menu-button">Start Simulation</button>
    <button id="stop-simulation-button" class="menu-button">Stop Simulation</button>
  </div>
  
  <div class="menu-section">
    <h3>Agent Management</h3>
    <button id="add-agent-button" class="menu-button">Add Agent</button>
    <button id="remove-agent-button" class="menu-button">Remove Agent</button>
    <button id="list-agents-button" class="menu-button">List Agents</button>
  </div>
  
  <div class="menu-section">
    <h3>Instructions</h3>
    <textarea id="instructions-textarea" placeholder="Enter instructions here..."></textarea>
    <button id="set-instructions-button" class="menu-button">Set Instructions</button>
    <button id="show-instructions-button" class="menu-button">Show Instructions</button>
  </div>
  
  <div class="menu-section">
    <h3>Example Instructions</h3>
    <button id="example-1-button" class="menu-button">Load Example 1</button>
    <button id="example-2-button" class="menu-button">Load Example 2</button>
    <button id="example-3-button" class="menu-button">Load Example 3</button>
  </div>
  
  <div class="menu-section">
    <h3>User Settings</h3>
    <button id="set-nickname-button" class="menu-button">Set Nickname</button>
  </div>
  
  <div class="menu-section">
    <h3>Help</h3>
    <button id="help-button" class="menu-button">Show Help</button>
  </div>
</div>

<div id="file-export-menu">
  <svg id="file-export-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
  </svg>
</div>

<div id="file-export-overlay">
  <h3>Export Files</h3>
  <div id="file-drop-area">
    <p>Drop files here or click to select</p>
  </div>
  <button id="create-zip-button">Create and Download Zip</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script>
const chatLog = document.getElementById('chat-log');
const errorLog = document.getElementById('error-log');
const userInput = document.getElementById('user-input');
const contextInfo = document.getElementById('context-info');
const fileExplorer = document.getElementById('file-explorer');
const fileDisplay = document.getElementById('file-display');
const previewFrame = document.getElementById('preview-frame');
const preview = document.getElementById('preview');
const fileExportMenu = document.getElementById('file-export-menu');
const fileExportOverlay = document.getElementById('file-export-overlay');
const createZipButton = document.getElementById('create-zip-button');
const fileDropArea = document.getElementById('file-drop-area');
const leftMenu = document.getElementById('left-menu');
const leftMenuOverlay = document.getElementById('left-menu-overlay');
const saveProjectButton = document.getElementById('save-project-button');
const projectList = document.getElementById('project-list');
const startSimulationButton = document.getElementById('start-simulation-button');
const stopSimulationButton = document.getElementById('stop-simulation-button');
const addAgentButton = document.getElementById('add-agent-button');
const removeAgentButton = document.getElementById('remove-agent-button');
const listAgentsButton = document.getElementById('list-agents-button');
const instructionsTextarea = document.getElementById('instructions-textarea');
const setInstructionsButton = document.getElementById('set-instructions-button');
const showInstructionsButton = document.getElementById('show-instructions-button');
const example1Button = document.getElementById('example-1-button');
const example2Button = document.getElementById('example-2-button');
const example3Button = document.getElementById('example-3-button');
const setNicknameButton = document.getElementById('set-nickname-button');
const helpButton = document.getElementById('help-button');
const fullscreenButton = document.getElementById('fullscreen-button');

let AGENTS = [
  { name: 'Alice', specificInstructions: "You are a friendly and outgoing person who loves to make new friends.", context: new Set() },
  { name: 'Bob', specificInstructions: "You are a curious person who's always eager to learn new things.", context: new Set() },
  { name: 'Charlie', specificInstructions: "You are a debugger, you pay close attention to errors and correct when agents replace code with comments like '// The rest of the code remains the same'. You simulate user interations as nessecary.", context: new Set() }
];

let isSimulationRunning = false;
let systemInstructions = `Do not program unless relevant to the task. The most important rule when programming is "Do not include comments like "// The rest of the code remains the same" or "//... Previous code remains the same". Instead, write out the full implementation without commenting out codes, divide it into several files if necessary.** Remember that you do not have access to global variables. Use alternative methods for data persistence such as localStorage, sessionStorage, or data attributes on HTML elements. Instructions for when programming: 1. Always provide complete, executable code snippets. Do not use placeholder comments or leave parts of the implementation unfinished. 2. Do not include comments like "// The rest of the code remains the same" or "// ... [implementation here]". Instead, write out the full implementation. 3. If a full implementation would be excessively long, provide a complete, working example that demonstrates the core functionality, and then explain how it could beextended. 4. Use comments sparingly and only when they add value by explaining complex logic or non-obvious design decisions. Do not use comments as substitutes for actual code. 5. If you're unsure about a specific implementation detail, it's better to make a reasonable assumption and provide a complete solution, explaining your assumption, rather than leaving that part commented out or incomplete. 6. Always test the logic of your code mentally before providing it. Ensure that the code you generate is syntactically correct and follows best practices for the language in question. 7. Additional considerations: You should simulate user interactions when necessary, to debug and when relevant as if you are a user. If server-side and databases are needed use localStorage. The environment does not have a URL bar. Do not use pop-up alerts in your code. Scripts are automatically executed and should not require a human to execute. Use several files and make the project maintainable. You cannot use modules so you cannot use export and import. By following these guidelines, you will provide more valuable and directly usable code. When modifying HTML files, create HTML elements, unless they're dynamic. When styling, create css files, unless they're dynamic.`;

let projectInstructions = "You want to create beautiful 132x132 pixel art of a village.";

let userNickname = "User";
let files = {
  'index.html': `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template Project</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <h1>Template Project</h1>
        <p id="result"></p>
    </div>
    <script src="utils.js"><\/script>
    <script src="main.js"><\/script>
</body>
</html>`,
  'styles.css': `body {
    font-family: Arial, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
    background-color: #f0f0f0;
}

#app {
    text-align: center;
    padding: 20px;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

h1 {
    color: #333;
}

#result {
    font-size: 18px;
    color: #666;
}`,
  'utils.js': `function generateRandomNumber(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}`,
  'main.js': `document.addEventListener('DOMContentLoaded', () => {
    const resultElement = document.getElementById('result');
    const randomNumber = generateRandomNumber(1, 100);
    resultElement.textContent = \`The random number is: \${randomNumber}\`;
});`
};
let lastModifiedFile = 'index.html';
let isFullscreen = false;

// Add this new variable to store user input history
let userInputHistory = [];
let userInputHistoryIndex = -1;

// Add this new variable to store chat history
let chatHistory = [];

// New variable to store example instructions
const exampleInstructions = {
  1: `You are a creative storyteller. Your task is to collaboratively create an engaging short story. Each agent should contribute a sentence or two to advance the plot, develop characters, or describe the setting.`,
  2: `You are a team of web developers working on a simple to-do list application. Focus on creating the HTML structure, styling with CSS, and adding interactivity with JavaScript. Each agent should contribute to a different aspect of the application.`,
  3: `You are a group of environmental scientists brainstorming ideas for sustainable urban development. Each agent should propose and discuss innovative solutions for energy efficiency, waste management, or green spaces in cities.`
};

function addChatMessage(message, sender) {
  const messageElement = document.createElement('div');
  messageElement.className = `message ${sender.toLowerCase()}`;
  messageElement.innerHTML = `<strong>${sender}:</strong> ${message}`;
  chatLog.appendChild(messageElement);
  chatLog.scrollTop = chatLog.scrollHeight;

  // Add message to chat history
  chatHistory.push({ sender, message });
}

function logError(error) {
  errorLog.textContent = `Error: ${error}`;
  addChatMessage(`Error: ${error}`, "System");
}

function updateFileExplorer() {
  fileExplorer.innerHTML = '';
  Object.keys(files).forEach(fileName => {
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    fileItem.textContent = fileName;
    fileItem.onclick = () => displayFile(fileName);
    fileExplorer.appendChild(fileItem);
  });
}

function displayFile(fileName) {
  lastModifiedFile = fileName;
  updateFileDisplay();
}

function updateFileDisplay() {
  if (lastModifiedFile) {
    fileDisplay.textContent = `File: ${lastModifiedFile}\n\nContent:\n${files[lastModifiedFile]}`;
  } else {
    fileDisplay.textContent = "No file selected.";
  }
}

function updatePreview() {
  const indexHtml = files['index.html'];
  if (indexHtml) {
    const blob = new Blob([indexHtml], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    
    previewFrame.onload = () => {
      URL.revokeObjectURL(url);
      
      // Inject CSS file
      if (files['styles.css']) {
        const style = previewFrame.contentDocument.createElement('style');
        style.textContent = files['styles.css'];
        previewFrame.contentDocument.head.appendChild(style);
      }
      
      // Create a single script element to hold all JavaScript
      const combinedScript = previewFrame.contentDocument.createElement('script');
      
      // Combine all JavaScript files
      Object.keys(files).forEach(fileName => {
        if (fileName.endsWith('.js')) {
          combinedScript.textContent += files[fileName] + '\n';
        }
      });
      
      // Wrap the combined script in an IIFE and add error handling
      combinedScript.textContent = `
        (function() {
          try {
            ${combinedScript.textContent}
          } catch (error) {
            window.parent.postMessage({type: 'error', message: error.toString()}, '*');
          }
        })();
      `;
      
      previewFrame.contentDocument.body.appendChild(combinedScript);

      // Override console methods
      const consoleMethods = ['log', 'error', 'warn', 'info', 'debug'];
      consoleMethods.forEach(method => {
        previewFrame.contentWindow.console[method] = (...args) => {
          window.parent.postMessage({type: 'console', method, args}, '*');
        };
      });

      // Capture unhandled promise rejections
      previewFrame.contentWindow.addEventListener('unhandledrejection', (event) => {
        window.parent.postMessage({type: 'error', message: `Unhandled Promise Rejection: ${event.reason}`}, '*');
      });

      // Capture all other errors
      previewFrame.contentWindow.addEventListener('error', (event) => {
        window.parent.postMessage({type: 'error', message: `Runtime Error: ${event.message} at ${event.filename}:${event.lineno}:${event.colno}`}, '*');
      });

      // Override setTimeout and setInterval to catch errors
      ['setTimeout', 'setInterval'].forEach(timerFunc => {
        const original = previewFrame.contentWindow[timerFunc];
        previewFrame.contentWindow[timerFunc] = (callback, delay, ...args) => {
          return original.call(previewFrame.contentWindow, (...cbArgs) => {
            try {
              callback.apply(this, cbArgs);
            } catch (error) {
              window.parent.postMessage({type: 'error', message: `Error in ${timerFunc}: ${error.toString()}`}, '*');
            }
          }, delay, ...args);
        };
      });

      // Inject error-catching wrapper for event listeners
      const originalAddEventListener = previewFrame.contentWindow.EventTarget.prototype.addEventListener;
      previewFrame.contentWindow.EventTarget.prototype.addEventListener = function (type, listener, options) {
        const wrappedListener = (event) => {
          try {
            listener(event);
          } catch (error) {
            window.parent.postMessage({type: 'error', message: `Error in event listener (${type}): ${error.toString()}`}, '*');
          }
        };
        return originalAddEventListener.call(this, type, wrappedListener, options);
      };

      // Manually trigger DOMContentLoaded event
      const domContentLoadedEvent = new Event('DOMContentLoaded');
      previewFrame.contentDocument.dispatchEvent(domContentLoadedEvent);
    };
    
    previewFrame.src = url;
  } else {
    previewFrame.srcdoc = '<h1>No index.html file found</h1>';
  }
}

// Add event listener for messages from the iframe
window.addEventListener('message', (event) => {
  if (event.data.type === 'error') {
    logError(event.data.message);
  } else if (event.data.type === 'console') {
    const { method, args } = event.data;
    addChatMessage(`Preview ${method.charAt(0).toUpperCase() + method.slice(1)}: ${args.join(' ')}`, "System");
  }
});

function toggleFullscreen() {
  if (isFullscreen) {
    preview.classList.remove('fullscreen');
    isFullscreen = false;
    addChatMessage("Preview exited fullscreen mode", "System");
  } else {
    preview.classList.add('fullscreen');
    isFullscreen = true;
    addChatMessage("Preview entered fullscreen mode. Press ESC to exit.", "System");
  }
}

function fixScriptTag(content) {
  return content.replace(/<script>/g, '<script>').replace(/<\/script>/g, '<\/script>');
}

function updateAgentContext() {
  AGENTS.forEach(agent => {
    agent.context.clear();
    Object.entries(files).forEach(([fileName, content]) => {
      agent.context.add(`File: ${fileName}\nContent: ${content}`);
    });
    // Add chat history to agent context
    chatHistory.forEach(({ sender, message }) => {
      agent.context.add(`${sender}: ${message}`);
    });
  });
}

function processFileActions(actions) {
  let indexHtmlModified = false;
  actions.forEach(action => {
    switch (action.action) {
      case 'new':
        files[action.name] = fixScriptTag(action.content);
        lastModifiedFile = action.name;
        if (action.name === 'index.html') indexHtmlModified = true;
        break;
      case 'rename':
        if (files[action.oldName]) {
          files[action.newName] = files[action.oldName];
          delete files[action.oldName];
          lastModifiedFile = action.newName;
          if (action.oldName === 'index.html' || action.newName === 'index.html') indexHtmlModified = true;
        }
        break;
      case 'delete':
        delete files[action.name];
        lastModifiedFile = null;
        if (action.name === 'index.html') indexHtmlModified = true;
        break;
      case 'edit':
        files[action.name] = fixScriptTag(action.content);
        lastModifiedFile = action.name;
        if (action.name === 'index.html') indexHtmlModified = true;
        break;
    }
  });
  updateFileExplorer();
  updateFileDisplay();
  updatePreview();
  updateAgentContext();
}

async function getAgentAction(agent, userInput = '') {
  const context = `
    ${agent.specificInstructions || ''}
    [Project Instructions] ${projectInstructions}
    [System Instructions] ${systemInstructions}

    Current state:
    Name: ${agent.name}

    Other agents: ${AGENTS.filter(a => a !== agent).map(a => a.name).join(', ')}

    Files:
    ${Array.from(agent.context).join('\n\n')}

    ${userInput ? `User input: ${userInput}` : ''}

    Provide a response for the agent based on their personality and the current situation.
    Your response should be in JSON format with 'response' and 'fileActions' fields.
    File actions can include:
    - new: Create a new file (provide name with extension)
    - rename: Rename an existing file
    - delete: Delete a file
    - edit: Edit the content of a file

    Example response format:
    {
      "response": "Your message here",
      "fileActions": [
        {"action": "new", "name": "example.js", "content": "console.log('Hello, world!');"},
        {"action": "rename", "oldName": "old.txt", "newName": "new.txt"},
        {"action": "delete", "name": "unwanted.css"},
        {"action": "edit", "name": "existing.html", "content":
 "<h1>Updated content</h1>"}
      ]
    }
  `;

  try {
    const response = await fetch('/api/intelligent-ai', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ 
        message: context,
        system: agent.specificInstructions || `${projectInstructions} ${systemInstructions}`
      })
    });

    const rawData = await response.text();
    let data;

    try {
      // First, try to parse the response as-is
      data = JSON.parse(rawData);
    } catch (error) {
      // If parsing fails, try to clean up the response
      const cleanedData = rawData
        .replace(/\\n/g, '\\n')  // Replace literal \n with escaped \n
        .replace(/\\'/g, "\\'")  // Replace literal \' with escaped \'
        .replace(/\\"/g, '\\"')  // Replace literal \" with escaped \"
        .replace(/\\&/g, '\\&')  // Replace literal \& with escaped \&
        .replace(/\\r/g, '\\r')  // Replace literal \r with escaped \r
        .replace(/\\t/g, '\\t')  // Replace literal \t with escaped \t
        .replace(/\\b/g, '\\b')  // Replace literal \b with escaped \b
        .replace(/\\f/g, '\\f')  // Replace literal \f with escaped \f
        .replace(/[\u0000-\u0019]+/g, ""); // Remove non-printable characters
      
      try {
        data = JSON.parse(cleanedData);
      } catch (secondError) {
        throw new Error(`Failed to parse response after cleaning: ${secondError.message}`);
      }
    }
    
    if (!data.response || !data.fileActions) {
      throw new Error(`Invalid response format for ${agent.name}: ${JSON.stringify(data)}`);
    }
    
    return data;
  } catch (error) {
    logError(`Error for ${agent.name}: ${error}`);
    return {
      response: "The agent seems confused and does nothing.",
      fileActions: []
    };
  }
}

async function simulationStep(userInput = '') {
  addChatMessage(userInput, userNickname);
  for (const agent of AGENTS) {
    const { response, fileActions } = await getAgentAction(agent, userInput);
    addChatMessage(response, agent.name);
    processFileActions(fileActions);
  }

  updateContextInfo();

  if (isSimulationRunning) {
    setTimeout(() => simulationStep(), 5000);
  }
}

function updateContextInfo() {
  contextInfo.innerHTML = `
    <h3>Current Agents:</h3>
    <ul>
      ${AGENTS.map(agent => `<li>${agent.name}</li>`).join('')}
    </ul>
    <p><strong>Simulation Status:</strong> ${isSimulationRunning ? 'Running' : 'Stopped'}</p>
    <p><strong>Your Nickname:</strong> ${userNickname}</p>
  `;
}

function startSimulation() {
  isSimulationRunning = true;
  addChatMessage("Simulation started", "System");
  updateAgentContext();
  simulationStep();
}

function stopSimulation() {
  isSimulationRunning = false;
  addChatMessage("Simulation stopped", "System");
}

function addAgent(name) {
  if (name && !AGENTS.some(agent => agent.name === name)) {
    AGENTS.push({ name, specificInstructions: '', context: new Set() });
    addChatMessage(`Agent ${name} added`, "System");
    updateContextInfo();
    updateAgentContext();
  } else {
    logError(`Invalid agent name or agent already exists: ${name}`);
  }
}

function removeAgent(name) {
  const index = AGENTS.findIndex(agent => agent.name === name);
  if (index !== -1) {
    AGENTS.splice(index, 1);
    addChatMessage(`Agent ${name} removed`, "System");
    updateContextInfo();
  } else {
    logError(`Agent not found: ${name}`);
  }
}

function setInstructions(agentName, instructions) {
  const agent = AGENTS.find(a => a.name === agentName);
  if (agent) {
    agent.specificInstructions = instructions;
    addChatMessage(`Instructions updated for ${agentName}`, "System");
  } else if (agentName.toLowerCase() === 'system') {
    systemInstructions = instructions;
    addChatMessage("System instructions updated", "System");
  } else if (agentName.toLowerCase() === 'project') {
    projectInstructions = instructions;
    addChatMessage("Project instructions updated", "System");
  } else {
    logError(`Agent not found: ${agentName}`);
  }
}

function setNickname(newNickname) {
  if (newNickname) {
    userNickname = newNickname;
    addChatMessage(`Your nickname has been set to: ${userNickname}`, "System");
    updateContextInfo();
  } else {
    logError("Invalid nickname. Please provide a non-empty nickname.");
  }
}

function loadInstructions(jsonContent) {
  try {
    const instructionsData = JSON.parse(jsonContent);
    
    if (instructionsData.systemInstructions) {
      systemInstructions = instructionsData.systemInstructions;
      addChatMessage("System instructions updated", "System");
    }
    
    if (instructionsData.projectInstructions) {
      projectInstructions = instructionsData.projectInstructions;
      addChatMessage("Project instructions updated", "System");
    }
    
    if (Array.isArray(instructionsData.agents)) {
      AGENTS = instructionsData.agents.map(agentData => ({
        name: agentData.name,
        specificInstructions: agentData.instructions,
        context: new Set()
      }));
      addChatMessage("Agents and their instructions updated", "System");
    }
    
    updateContextInfo();
    updateAgentContext();
  } catch (error) {
    logError(`Error parsing instructions JSON: ${error.message}`);
  }
}

function createAndDownloadZip() {
  const zip = new JSZip();

  Object.entries(files).forEach(([fileName, content]) => {
    zip.file(fileName, content);
  });

  zip.generateAsync({ type: "blob" })
    .then(function(content) {
      saveAs(content, "project.zip");
      addChatMessage("Project files downloaded as ZIP", "System");
    });
}

function saveProject(projectName) {
  if (!projectName) {
    logError("Please provide a project name.");
    return;
  }

  const projectData = {
    files,
    agents: AGENTS.map(agent => ({
      name: agent.name,
      specificInstructions: agent.specificInstructions
    })),
    systemInstructions,
    projectInstructions,
    chatHistory,
    isSimulationRunning,
    userNickname
  };

  try {
    localStorage.setItem(`project_${projectName}`, JSON.stringify(projectData));
    addChatMessage(`Project "${projectName}" saved successfully.`, "System");
    updateProjectList();
  } catch (error) {
    logError(`Failed to save project: ${error.message}`);
  }
}

function loadProject(projectName) {
  try {
    const projectData = JSON.parse(localStorage.getItem(`project_${projectName}`));
    if (projectData) {
      files = projectData.files;
      AGENTS = projectData.agents.map(agentData => ({
        ...agentData,
        context: new Set()
      }));
      systemInstructions = projectData.systemInstructions;
      projectInstructions = projectData.projectInstructions;
      chatHistory = projectData.chatHistory;
      isSimulationRunning = projectData.isSimulationRunning;
      userNickname = projectData.userNickname;

      updateFileExplorer();
      updateFileDisplay();
      updatePreview();
      updateContextInfo();
      updateAgentContext();

      // Clear the chat log and reload the chat history
      chatLog.innerHTML = '';
      chatHistory.forEach(({ sender, message }) => {
        addChatMessage(message, sender);
      });

      addChatMessage(`Project "${projectName}" loaded successfully.`, "System");
    } else {
      logError(`Project "${projectName}" not found.`);
    }
  } catch (error) {
    logError(`Failed to load project: ${error.message}`);
  }
}

function deleteProject(projectName) {
  try {
    localStorage.removeItem(`project_${projectName}`);
    addChatMessage(`Project "${projectName}" deleted successfully.`, "System");
    updateProjectList();
  } catch (error) {
    logError(`Failed to delete project: ${error.message}`);
  }
}

function updateProjectList() {
  projectList.innerHTML = '';
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith('project_')) {
      const projectName = key.slice(8); // Remove 'project_' prefix
      const projectItem = document.createElement('div');
      projectItem.className = 'project-item';
      projectItem.innerHTML = `
        <span>${projectName}</span>
        <div>
          <button class="load-project-button" data-project="${projectName}">Load</button>
          <button class="delete-project-button" data-project="${projectName}">Delete</button>
        </div>
      `;
      projectList.appendChild(projectItem);
    }
  }

  // Add event listeners to load and delete buttons
  const loadButtons = document.querySelectorAll('.load-project-button');
  const deleteButtons = document.querySelectorAll('.delete-project-button');
  
  loadButtons.forEach(button => {
    button.addEventListener('click', () => {
      const projectName = button.getAttribute('data-project');
      loadProject(projectName);
    });
  });
  
  deleteButtons.forEach(button => {
    button.addEventListener('click', () => {
      const projectName = button.getAttribute('data-project');
      if (confirm(`Are you sure you want to delete the project "${projectName}"?`)) {
        deleteProject(projectName);
      }
    });
  });
}

function loadExampleInstructions(exampleNumber) {
  if (exampleInstructions[exampleNumber]) {
    projectInstructions = exampleInstructions[exampleNumber];
    addChatMessage(`Loaded example instructions ${exampleNumber}`, "System");
    updateAgentContext();
  } else {
    logError(`Example instructions ${exampleNumber} not found`);
  }
}

function showInstructions() {
  addChatMessage("Current Instructions:", "System");
  addChatMessage("Project Instructions:", "System");
  addChatMessage(projectInstructions, "System");
  addChatMessage("System Instructions:", "System");
  addChatMessage(systemInstructions, "System");
  
  AGENTS.forEach(agent => {
    addChatMessage(`Instructions for ${agent.name}:`, "System");
    addChatMessage(agent.specificInstructions || "No specific instructions set.", "System");
  });
}

function help() {
  addChatMessage("Available commands:", "System");
  addChatMessage("!start - Start the simulation", "System");
  addChatMessage("!stop - Stop the simulation", "System");
  addChatMessage("!add [name] - Add a new agent", "System");
  addChatMessage("!remove [name] - Remove an agent", "System");
  addChatMessage("!set [name/system/project] [instructions] - Set instructions for an agent, system, or project", "System");
  addChatMessage("!list - List all agents", "System");
  addChatMessage("!nick [nickname] - Set your nickname", "System");
  addChatMessage("!fullscreen - Toggle fullscreen preview", "System");
  addChatMessage("!load [JSON] - Load instructions from JSON", "System");
  addChatMessage("!help - Show this help message", "System");
  addChatMessage("!save [projectName] - Save the current project", "System");
  addChatMessage("!load [projectName] - Load a saved project", "System");
  addChatMessage("!delete [projectName] - Delete a saved project", "System");
  addChatMessage("!example [1-3] - Load example instructions", "System");
  addChatMessage("!show - Show current instructions for all agents, system, and project", "System");
}

function processCommand(input) {
  if (!input.startsWith('!')) {
    if (isSimulationRunning) {
      simulationStep(input);
    } else {
      addChatMessage("Simulation is not running. Start it with !start command.", "System");
    }
    return;
  }

  const [command, ...args] = input.slice(1).split(' ');
  
  switch (command.toLowerCase()) {
    case 'start':
      startSimulation();
      break;
    case 'stop':
      stopSimulation();
      break;
    case 'add':
      addAgent(args[0]);
      break;
    case 'remove':
      removeAgent(args[0]);
      break;
    case 'set':
      setInstructions(args[0], args.slice(1).join(' '));
      break;
    case 'list':
      addChatMessage(`Agents: ${AGENTS.map(a => a.name).join(', ')}`, "System");
      break;
    case 'nick':
      setNickname(args.join(' '));
      break;
    case 'fullscreen':
      toggleFullscreen();
      break;
    case 'load':
      if (args[0] === 'instructions') {
        loadInstructions(args.slice(1).join(' '));
      } else {
        loadProject(args[0]);
      }
      break;
    case 'save':
      saveProject(args[0]);
      break;
    case 'delete':
      deleteProject(args[0]);
      break;
    case 'help':
      help();
      break;
    case 'example':
      const exampleNumber = parseInt(args[0]);
      if (exampleNumber >= 1 && exampleNumber <= 3) {
        loadExampleInstructions(exampleNumber);
      } else {
        logError("Invalid example number. Use !example [1-3]");
      }
      break;
    case 'show':
      showInstructions();
      break;
    default:
      addChatMessage(`Unknown command: ${command}. Type !help for available commands.`, "System");
  }
}

userInput.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    const input = this.value.trim();
    if (input) {
      userInputHistory.push(input);
      userInputHistoryIndex = userInputHistory.length;
      processCommand(input);
      this.value = '';
    }
  }
});

userInput.addEventListener('keydown', function(e) {
  if (e.key === 'ArrowUp') {
    if (userInputHistoryIndex > 0) {
      userInputHistoryIndex--;
      this.value = userInputHistory[userInputHistoryIndex];
    }
    e.preventDefault();
  } else if (e.key === 'ArrowDown') {
    if (userInputHistoryIndex < userInputHistory.length - 1) {
      userInputHistoryIndex++;
      this.value = userInputHistory[userInputHistoryIndex];
    } else if (userInputHistoryIndex === userInputHistory.length - 1) {
      userInputHistoryIndex++;
      this.value = '';
    }
    e.preventDefault();
  }
});

fileExportMenu.addEventListener('click', () => {
  fileExportOverlay.classList.toggle('active');
});

createZipButton.addEventListener('click', createAndDownloadZip);

leftMenu.addEventListener('click', () => {
  leftMenuOverlay.classList.toggle('active');
});

saveProjectButton.addEventListener('click', () => {
  const projectName = prompt("Enter a name for your project:");
  if (projectName) {
    saveProject(projectName);
  }
});

startSimulationButton.addEventListener('click', startSimulation);
stopSimulationButton.addEventListener('click', stopSimulation);

addAgentButton.addEventListener('click', () => {
  const agentName = prompt("Enter the name for the new agent:");
  if (agentName) {
    addAgent(agentName);
  }
});

removeAgentButton.addEventListener('click', () => {
  const agentName = prompt("Enter the name of the agent to remove:");
  if (agentName) {
    removeAgent(agentName);
  }
});

listAgentsButton.addEventListener('click', () => {
  addChatMessage(`Agents: ${AGENTS.map(a => a.name).join(', ')}`, "System");
});

setInstructionsButton.addEventListener('click', () => {
  const target = prompt("Enter 'system', 'project', or an agent's name:");
  const instructions = instructionsTextarea.value;
  if (target && instructions) {
    setInstructions(target, instructions);
  }
});

showInstructionsButton.addEventListener('click', showInstructions);

example1Button.addEventListener('click', () => loadExampleInstructions(1));
example2Button.addEventListener('click', () => loadExampleInstructions(2));
example3Button.addEventListener('click', () => loadExampleInstructions(3));

setNicknameButton.addEventListener('click', () => {
  const newNickname = prompt("Enter your new nickname:");
  if (newNickname) {
    setNickname(newNickname);
  }
});

helpButton.addEventListener('click', help);

fullscreenButton.addEventListener('click', toggleFullscreen);

// Initialize
updateFileExplorer();
updateFileDisplay();
updatePreview();
updateContextInfo();
updateProjectList();

addChatMessage("Welcome to the AI Agent Framework CLI! Type !help for available commands.", "System");
</script>
</body>
</html>
